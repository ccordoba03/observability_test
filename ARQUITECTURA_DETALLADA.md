# Arquitectura TÃ©cnica - Diagramas y Flujos

## ğŸ“ DIAGRAMA DE ARQUITECTURA GENERAL

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           AWS ACCOUNT (us-east-1)                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ VPC: 10.0.0.0/16 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                                                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚ â”‚
â”‚  â”‚  â”‚  AZ us-east- â”‚  â”‚  AZ us-east- â”‚  â”‚  AZ us-east- â”‚         â”‚ â”‚
â”‚  â”‚  â”‚     1a       â”‚  â”‚     1b       â”‚  â”‚     1c       â”‚         â”‚ â”‚
â”‚  â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤         â”‚ â”‚
â”‚  â”‚  â”‚ Pub Subnet   â”‚  â”‚ Pub Subnet   â”‚  â”‚ Pub Subnet   â”‚         â”‚ â”‚
â”‚  â”‚  â”‚ 10.0.1xx.0  â”‚  â”‚ 10.0.2xx.0  â”‚  â”‚ 10.0.3xx.0  â”‚         â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚ â”‚
â”‚  â”‚         â†“                                                       â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚ â”‚
â”‚  â”‚  â”‚         NAT Gateway (Outbound)              â”‚             â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚ â”‚
â”‚  â”‚         â†“         â†“          â†“                                 â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚ â”‚
â”‚  â”‚  â”‚Priv Subnet   â”‚ â”‚Priv Subnet   â”‚ â”‚Priv Subnet   â”‚          â”‚ â”‚
â”‚  â”‚  â”‚ 10.0.1.0/24 â”‚ â”‚ 10.0.2.0/24 â”‚ â”‚ 10.0.3.0/24 â”‚          â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚ â”‚
â”‚  â”‚         â†“               â†“                  â†“                  â”‚ â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚ â”‚
â”‚  â”‚   â”‚      EKS Cluster: eks-observability             â”‚        â”‚ â”‚
â”‚  â”‚   â”‚         Kubernetes v1.29, IRSA Enabled        â”‚        â”‚ â”‚
â”‚  â”‚   â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤        â”‚ â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚    Control Plane (AWS Managed)        â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚  OIDC Provider: untuk IRSA            â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚                                               â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  Nodos: t3.medium x2 (Managed) + Karpenter  â”‚        â”‚ â”‚
â”‚  â”‚   â”‚                                               â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ observability namespace              â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ grafana-alloy (DaemonSet)     â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ ServiceAccount: grafana-alloy â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Annotated with IRSA role ARN  â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚                               â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Recolecta mÃ©tricas via:      â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ - discovery.kubernetes.pods  â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ - prometheus.scrape           â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ - prometheus.remote_write     â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ karpenter (karpenter) Helm     â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Controller para autoscaling    â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ SQS: Interruption handling     â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ NodePool: t3.medium, m5.large â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ LÃ­mite: 200 CPU, 400Gi RAM    â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚                                               â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ kube-system namespace                â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ aws-load-balancer-controller   â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ ServiceAccount: aws-lb-ctrller â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Annotated with IRSA role ARN   â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚                               â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Monitorea Ingress resources:  â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ - Crea ALBs automÃ¡ticamente   â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ - Configura target groups     â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ - Gestiona listeners          â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚                                               â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ app-demo namespace                   â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Deployment: hello-world        â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Image: nginx:alpine            â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Replicas: 1                    â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ envFrom: app-secret (de ESO)   â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚                               â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Service: hello-world (ClusterIP) â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Port: 80                       â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚                               â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Ingress: hello-world           â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Class: alb (internet-facing)   â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ â†’ ALB creado automÃ¡ticamente   â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ â†’ DNS: k8s-appdemo-hellowor..  â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ ServiceAccount: app-sa         â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Annotated with AppRole ARN     â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Accede a AWS Secrets Manager   â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚                               â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ SecretStore: aws-secretsmanager  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ ExternalSecret: app-secret (SYNCED) â”‚ â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚                                               â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ external-secrets-system namespace   â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ external-secrets-operator      â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Helm: external-secrets v0.9.0 â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Sincroniza AWS â†’ K8s Secrets   â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚                                               â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ developer-ns namespace (RBAC demo)  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Role: developer-view           â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Permisos: get,list,watch       â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ Resources: pods,services,cfgs  â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚                               â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ RoleBinding: developer-binding â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â”‚ User: developer-user           â”‚  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚        â”‚ â”‚
â”‚  â”‚   â”‚                                               â”‚        â”‚ â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚ â”‚
â”‚  â”‚                                                           â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      AWS Services (fuera de VPC)               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”‚
â”‚  â”‚   ELB / ALB          â”‚      â”‚  AWS Secrets Manager â”‚        â”‚
â”‚  â”‚  (Load Balancer)     â”‚      â”‚  eks-observability-  â”‚        â”‚
â”‚  â”‚ creado por:          â”‚      â”‚  app-secret (KMS)    â”‚        â”‚
â”‚  â”‚ ALB Controller       â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜        â”‚
â”‚  â”‚                      â”‚              â†‘                       â”‚
â”‚  â”‚ Escucha: 0.0.0.0:80 â”‚              â”‚                       â”‚
â”‚  â”‚ Destino: EKS pods    â”‚          (lectura)                   â”‚
â”‚  â”‚ DNS pÃºblico          â”‚              â”‚                       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚                       â”‚
â”‚           â†‘                            â”‚                       â”‚
â”‚      (recibe requests HTTP)        (ESO sync)                  â”‚
â”‚           â”‚                            â”‚                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”               â”‚
â”‚  â”‚                                             â”‚               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚               â”‚
â”‚  â”‚  â”‚ Amazon Managed Prometheus (AMP)    â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ Workspace: eks-observability-amp   â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ Endpoint: aps-workspaces.us-east-1â”‚    â”‚               â”‚
â”‚  â”‚  â”‚                                    â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ Recibe:                            â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ - MÃ©tricas de Alloy (SigV4/IRSA)   â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ - remote_write endpoint            â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ - Almacena series de tiempo        â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ - AlertManager integrado           â”‚    â”‚               â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚               â”‚
â”‚  â”‚                                             â”‚               â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚               â”‚
â”‚  â”‚  â”‚     IAM (Roles & Policies)         â”‚    â”‚               â”‚
â”‚  â”‚  â”‚                                    â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ 1. GrafanaAlloyRole (IRSA)        â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â”œâ”€ AssumeRole: OIDC JWT        â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â”œâ”€ Condition: ServiceAccount   â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â”‚  observability:grafana-alloy â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â””â”€ Policy: aps:RemoteWrite     â”‚    â”‚               â”‚
â”‚  â”‚  â”‚       Resource: AMP workspace ARN â”‚    â”‚               â”‚
â”‚  â”‚  â”‚                                    â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ 2. ALBControllerRole (IRSA)       â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â”œâ”€ AssumeRole: OIDC JWT        â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â”œâ”€ Condition: ServiceAccount   â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â”‚  kube-system:aws-lb-ctrller  â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â”œâ”€ Policy: ElasticLoadBalance  â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â””â”€ Policy: ALBControllerEC2    â”‚    â”‚               â”‚
â”‚  â”‚  â”‚       (CreateSecurityGroup, etc)  â”‚    â”‚               â”‚
â”‚  â”‚  â”‚                                    â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ 3. AppRole (IRSA)                 â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â”œâ”€ AssumeRole: OIDC JWT        â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â”œâ”€ Condition: ServiceAccount   â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â”‚  app-demo:app-sa             â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â””â”€ Policy: secretsmanager:Get  â”‚    â”‚               â”‚
â”‚  â”‚  â”‚       Resource: especÃ­fico secret â”‚    â”‚               â”‚
â”‚  â”‚  â”‚                                    â”‚    â”‚               â”‚
â”‚  â”‚  â”‚ 4. KarpenterNodeRole              â”‚    â”‚               â”‚
â”‚  â”‚  â”‚    â””â”€ Attached a EC2 instances    â”‚    â”‚               â”‚
â”‚  â”‚  â”‚       (nodes launched by Karpenter)   â”‚               â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚               â”‚
â”‚  â”‚                                             â”‚               â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ”„ FLUJO 1: RecolecciÃ³n de MÃ©tricas (Alloy â†’ AMP)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Pod Nginx (app-demo namespace)                              â”‚
â”‚    Escucha: :80                                                â”‚
â”‚    Expone mÃ©tricas en: /metrics (estÃ¡ndar Prometheus)         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Grafana Alloy DaemonSet (observability namespace)           â”‚
â”‚    Container: alloy (v1.4.1)                                  â”‚
â”‚                                                                â”‚
â”‚    A) discovery.kubernetes "pods" {                           â”‚
â”‚       - Descubre todos los pods del cluster                   â”‚
â”‚       - Identifica puertos con mÃ©tricas                       â”‚
â”‚       - Targets: todos los pods que exponen mÃ©tricas          â”‚
â”‚    }                                                           â”‚
â”‚                                                                â”‚
â”‚    B) prometheus.scrape "kubernetes" {                        â”‚
â”‚       - Scrapes targets cada 15s (default)                   â”‚
â”‚       - Recolecta mÃ©tricas (CPU, memoria, requests, etc)    â”‚
â”‚       - Forward to: prometheus.remote_write.default           â”‚
â”‚    }                                                           â”‚
â”‚                                                                â”‚
â”‚    C) prometheus.remote_write "default" {                     â”‚
â”‚       - URL: https://aps-workspaces.us-east-1.amazonaws.com  â”‚
â”‚              /workspaces/ws-5a054a55.../api/v1/remote_write  â”‚
â”‚       - SigV4 autenticaciÃ³n (IRSA)                           â”‚
â”‚       - EnvÃ­a batches de mÃ©tricas a AMP                      â”‚
â”‚    }                                                           â”‚
â”‚                                                                â”‚
â”‚    ServiceAccount: grafana-alloy                              â”‚
â”‚    - Anotado: eks.amazonaws.com/role-arn = GrafanaAlloyRole  â”‚
â”‚    - Kubelet intercepciÃ³n OIDC token â†“                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ (IRSA Magic)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. OIDC Provider (EKS cluster)                                 â”‚
â”‚    - Valida JWT del pod                                       â”‚
â”‚    - Subject: system:serviceaccount:observability:grafana-alloy
â”‚    - Emite credenciales temporales de AWS                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. AWS STS (Security Token Service)                            â”‚
â”‚    - Valida OIDC token del cluster                            â”‚
â”‚    - Consulta AssumeRoleWithWebIdentity                       â”‚
â”‚    - Retorna: AccessKeyId, SecretAccessKey, SessionToken     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ (Auto-injected by kubelet)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Alloy (ahora con credenciales temporales de AWS)            â”‚
â”‚    - AWS_ROLE_ARN = GrafanaAlloyRole ARN                      â”‚
â”‚    - AWS_WEB_IDENTITY_TOKEN_FILE = /var/run/secrets/...token  â”‚
â”‚    - AWS SDK auto-refreshes every ~1hr                        â”‚
â”‚                                                                â”‚
â”‚    â†’ Intenta remote_write a AMP                               â”‚
â”‚    â†’ Firma request con SigV4 (credenciales temporales)       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ (HTTPS + SigV4)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Amazon Managed Prometheus (AMP)                             â”‚
â”‚    - Recibe HTTP request con SigV4 signature                  â”‚
â”‚    - Valida signature (confirma que es de AlloyRole)         â”‚
â”‚    - Valida permisos (aps:RemoteWrite en workspace ARN)      â”‚
â”‚    - âœ… AutenticaciÃ³n exitosa                                 â”‚
â”‚    - Almacena mÃ©tricas en workspace                          â”‚
â”‚    - Disponibles para queries/dashboards                     â”‚
â”‚                                                                â”‚
â”‚    MÃ©todos soportados:                                       â”‚
â”‚    - /api/v1/remote_write (POST, Prometheus remote write)    â”‚
â”‚    - /api/v1/query (GET, PromQL queries)                     â”‚
â”‚    - /api/v1/query_range (GET, time-series queries)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Resultado de Logs:
âœ… ts=2026-01-09T01:07:55... level=info msg="now listening for http traffic"
âœ… ts=2026-01-09T01:08:06... level=info msg="Done replaying WAL"
âœ… (Sin 403 errors despuÃ©s de implementar IRSA + SigV4)
```

---

## ğŸ” FLUJO 2: SincronizaciÃ³n de Secretos (AWS Secrets Manager â†’ K8s)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. AWS Secrets Manager                                         â”‚
â”‚    Secret: eks-observability-app-secret                       â”‚
â”‚    Value: { "API_KEY": "my-secret-api-key" }                 â”‚
â”‚    Encriptado con: AWS KMS (default key)                     â”‚
â”‚    Acceso: Solo AuthZ personas/roles                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ (ESO polling cada 15s)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. External Secrets Operator (ESO)                            â”‚
â”‚    Namespace: external-secrets-system                         â”‚
â”‚    Pod: external-secrets-*                                   â”‚
â”‚    Helm: 0.9.0                                              â”‚
â”‚                                                                â”‚
â”‚    Monitorea: ExternalSecret resources                       â”‚
â”‚    - app-demo namespace                                      â”‚
â”‚    - Nombre: app-secret                                      â”‚
â”‚    - refreshInterval: 15s                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ExternalSecret Resource (app-demo:app-secret)              â”‚
â”‚    apiVersion: external-secrets.io/v1beta1                   â”‚
â”‚    kind: ExternalSecret                                      â”‚
â”‚                                                                â”‚
â”‚    spec:                                                       â”‚
â”‚    - refreshInterval: 15s                                    â”‚
â”‚    - secretStoreRef:                                          â”‚
â”‚        name: aws-secretsmanager                              â”‚
â”‚        kind: SecretStore                                     â”‚
â”‚                                                                â”‚
â”‚    - target:                                                  â”‚
â”‚        name: app-secret (donde guardar)                      â”‚
â”‚        creationPolicy: Owner                                 â”‚
â”‚                                                                â”‚
â”‚    - data:                                                    â”‚
â”‚      - secretKey: API_KEY (clave en K8s Secret)             â”‚
â”‚        remoteRef:                                             â”‚
â”‚          key: eks-observability-app-secret (AWS secret)      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. SecretStore Resource (app-demo:aws-secretsmanager)         â”‚
â”‚    apiVersion: external-secrets.io/v1beta1                   â”‚
â”‚    kind: SecretStore                                         â”‚
â”‚                                                                â”‚
â”‚    spec:                                                       â”‚
â”‚    - provider:                                                â”‚
â”‚        aws:                                                   â”‚
â”‚          service: SecretsManager                             â”‚
â”‚          region: us-east-1                                   â”‚
â”‚          auth:                                                â”‚
â”‚            jwt:                                               â”‚
â”‚              serviceAccountRef:                              â”‚
â”‚                name: app-sa (ServiceAccount)                â”‚
â”‚                                                                â”‚
â”‚    ServiceAccount: app-sa (app-demo)                         â”‚
â”‚    - Anotado: eks.amazonaws.com/role-arn = AppRole ARN       â”‚
â”‚    - AppRole tiene policy: secretsmanager:GetSecretValue     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ (ESO usa ServiceAccount app-sa)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. OIDC + IRSA (mismo flujo que Alloy)                        â”‚
â”‚    - JWT del ServiceAccount app-sa                           â”‚
â”‚    - AssumeRoleWithWebIdentity â†’ AppRole                     â”‚
â”‚    - Credenciales temporales de AWS                          â”‚
â”‚    - ESO autenticado como AppRole                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. AWS Secrets Manager API Call                               â”‚
â”‚    Method: GetSecretValue                                    â”‚
â”‚    SecretId: eks-observability-app-secret                    â”‚
â”‚    Signed with: AppRole credentials (SigV4)                  â”‚
â”‚    Response: { "API_KEY": "my-secret-api-key" }             â”‚
â”‚    Status: âœ… 200 OK                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. K8s Secret (Sincronizado)                                  â”‚
â”‚    Namespace: app-demo                                       â”‚
â”‚    Name: app-secret                                          â”‚
â”‚    Type: Opaque                                              â”‚
â”‚    Data:                                                      â”‚
â”‚    - API_KEY: my-secret-api-key (base64 encoded)            â”‚
â”‚    - Secret Sync Status: SecretSynced: True                 â”‚
â”‚    - Last Sync: 2026-01-09T01:20:30Z                        â”‚
â”‚    - Next Sync: 2026-01-09T01:20:45Z                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Deployment/Pod (app-demo:hello-world-xxx)                  â”‚
â”‚    Container: nginx:alpine                                   â”‚
â”‚    envFrom:                                                    â”‚
â”‚    - secretRef:                                               â”‚
â”‚        name: app-secret                                      â”‚
â”‚                                                                â”‚
â”‚    Resultado: Pod ENV variables                              â”‚
â”‚    - API_KEY=my-secret-api-key                              â”‚
â”‚                                                                â”‚
â”‚    âœ… Secret consumido de forma segura                        â”‚
â”‚    âœ… No expuesto en cÃ³digo                                   â”‚
â”‚    âœ… Rotable desde AWS Secrets Manager                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸŒ FLUJO 3: ExposiciÃ³n vÃ­a ALB (Ingress â†’ Internet)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Ingress Resource (app-demo:hello-world)                    â”‚
â”‚    apiVersion: networking.k8s.io/v1                          â”‚
â”‚    kind: Ingress                                             â”‚
â”‚    metadata:                                                  â”‚
â”‚      name: hello-world                                       â”‚
â”‚      namespace: app-demo                                    â”‚
â”‚      annotations:                                            â”‚
â”‚        kubernetes.io/ingress.class: alb                      â”‚
â”‚        alb.ingress.kubernetes.io/scheme: internet-facing    â”‚
â”‚        alb.ingress.kubernetes.io/target-type: ip             â”‚
â”‚    spec:                                                      â”‚
â”‚      rules:                                                   â”‚
â”‚      - http:                                                  â”‚
â”‚          paths:                                               â”‚
â”‚          - path: /                                            â”‚
â”‚            pathType: Prefix                                  â”‚
â”‚            backend:                                           â”‚
â”‚              service:                                         â”‚
â”‚                name: hello-world                             â”‚
â”‚                port: 80                                      â”‚
â”‚                                                                â”‚
â”‚    Status: Ingress created, not yet processed                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. AWS Load Balancer Controller (kube-system)                 â”‚
â”‚    Pod: aws-load-balancer-controller-*                       â”‚
â”‚    Helm: 2.7.0+                                              â”‚
â”‚    ServiceAccount: aws-load-balancer-controller              â”‚
â”‚    - Annotated with ALBControllerRole ARN                    â”‚
â”‚                                                                â”‚
â”‚    Observa cambios en Ingress resource â†“                     â”‚
â”‚    - Detecta: metadata.namespace=app-demo, name=hello-world â”‚
â”‚    - Anota class: alb â†’ es nuestro responsable               â”‚
â”‚    - Status: ingressClassName: alb â†’ True                   â”‚
â”‚                                                                â”‚
â”‚    Crea provisioning plan:                                   â”‚
â”‚    1. Crear ALB en AWS                                       â”‚
â”‚    2. Crear Target Group (IP targets, protocolo HTTP)        â”‚
â”‚    3. Crear Listener (puerto 80)                             â”‚
â”‚    4. Crear regla: path / â†’ target group                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“ (Controller usa IRSA)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. ALBControllerRole IAM (IRSA)                               â”‚
â”‚    ServiceAccount: aws-load-balancer-controller              â”‚
â”‚    - OIDC JWT â†’ Credenciales temporales                      â”‚
â”‚                                                                â”‚
â”‚    Policies:                                                  â”‚
â”‚    - ElasticLoadBalancingFullAccess (ELB, ALB, NLB)         â”‚
â”‚    - AmazonEC2ReadOnlyAccess (describe instances, etc)      â”‚
â”‚    - ALBControllerEC2Policy (CreateSecurityGroup, etc)      â”‚
â”‚                                                                â”‚
â”‚    IAM Calls:                                                 â”‚
â”‚    1. ec2:CreateSecurityGroup                                â”‚
â”‚    2. elbv2:CreateLoadBalancer                               â”‚
â”‚    3. elbv2:CreateTargetGroup                                â”‚
â”‚    4. elbv2:CreateListener                                   â”‚
â”‚    5. elbv2:CreateRule (path routing)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. AWS ALB Resources Created                                  â”‚
â”‚                                                                â”‚
â”‚    ALB (Application Load Balancer)                           â”‚
â”‚    - Name: k8s-appdemo-hellowor-7d652ffc17                   â”‚
â”‚    - Scheme: internet-facing                                 â”‚
â”‚    - Subnets: Public subnets (AZ a, b, c)                    â”‚
â”‚    - SecurityGroup: creado automÃ¡ticamente                   â”‚
â”‚    - DNS: k8s-appdemo-hellowor-7d652ffc17-973624858.us-east-1.elb.amazonaws.com
â”‚                                                                â”‚
â”‚    Target Group                                              â”‚
â”‚    - Name: k8s-appdemo-hellowor-...                          â”‚
â”‚    - Protocol: HTTP                                          â”‚
â”‚    - Port: 80                                                â”‚
â”‚    - VPC: eks-observability-vpc                              â”‚
â”‚    - Target Type: ip (pod IP addresses)                      â”‚
â”‚    - Health Check: /                                         â”‚
â”‚                                                                â”‚
â”‚    Listener                                                   â”‚
â”‚    - Port: 80                                                â”‚
â”‚    - Protocol: HTTP                                          â”‚
â”‚    - Default Action: Forward to Target Group                 â”‚
â”‚                                                                â”‚
â”‚    Rule                                                       â”‚
â”‚    - Host: * (cualquier host)                                â”‚
â”‚    - Path: / (raÃ­z)                                          â”‚
â”‚    - Action: Forward to Target Group                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Target Initialization                                      â”‚
â”‚    ALB Controller registra pod IPs como targets              â”‚
â”‚    - Pod: hello-world-xxx en IP 10.0.1.123:80               â”‚
â”‚    - Target Group: registra 10.0.1.123:80                   â”‚
â”‚                                                                â”‚
â”‚    Health Check:                                              â”‚
â”‚    - ALB â†’ 10.0.1.123:80 GET /                              â”‚
â”‚    - Pod responde: HTTP 200 (Nginx default page)            â”‚
â”‚    - Status: Healthy âœ…                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Ingress Status Updated                                     â”‚
â”‚    kubectl get ingress -n app-demo hello-world              â”‚
â”‚                                                                â”‚
â”‚    NAME          CLASS   HOSTS   ADDRESS                     â”‚
â”‚    hello-world   alb     *       k8s-appdemo-hellowor-...   â”‚
â”‚                                  us-east-1.elb.amazonaws.com â”‚
â”‚                                                                â”‚
â”‚    âœ… ADDRESS asignado (antes estaba vacÃ­o)                   â”‚
â”‚    âœ… ALB fully provisioned                                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Usuario/Cliente en Internet                                â”‚
â”‚                                                                â”‚
â”‚    curl http://k8s-appdemo-hellowor-7d652ffc17-973624858.us-east-1.elb.amazonaws.com
â”‚                                                                â”‚
â”‚    Request flow:                                              â”‚
â”‚    1. DNS: k8s-appdemo-... â†’ ALB IP (AWS managed DNS)        â”‚
â”‚    2. TCP: :80 â†’ ALB (internet-facing)                       â”‚
â”‚    3. ALB lookup: Path / â†’ Target Group                      â”‚
â”‚    4. ALB: Health checks target                              â”‚
â”‚    5. ALB forwards: HTTP â†’ Target IP:Port (10.0.1.123:80)   â”‚
â”‚    6. Pod: Nginx responds HTTP 200 + HTML                    â”‚
â”‚    7. ALB returns response to client                         â”‚
â”‚                                                                â”‚
â”‚    Response:                                                  â”‚
â”‚    HTTP/1.1 200 OK                                           â”‚
â”‚    Content-Type: text/html                                   â”‚
â”‚    <!DOCTYPE html>                                           â”‚
â”‚    <html>                                                     â”‚
â”‚    <head><title>Welcome to nginx!</title></head>            â”‚
â”‚    <body>                                                     â”‚
â”‚    <h1>Welcome to nginx!</h1>                                â”‚
â”‚    ...                                                        â”‚
â”‚    </body>                                                    â”‚
â”‚    </html>                                                    â”‚
â”‚                                                                â”‚
â”‚    âœ… Application accessible from internet                    â”‚
â”‚    âœ… Load balancing working                                 â”‚
â”‚    âœ… High availability across AZs                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ FLUJO 4: Autoscaling con Karpenter

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. Estado Inicial                                              â”‚
â”‚    Nodos: 2 x t3.medium (managed node group)                  â”‚
â”‚    Pods: hello-world (1), alloy (2), controller (1)          â”‚
â”‚    UtilizaciÃ³n: ~30% (bajo)                                  â”‚
â”‚    Karpenter: observando clusters                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2. Evento: Usuario escala Deployment                          â”‚
â”‚    kubectl scale deployment hello-world --replicas=50        â”‚
â”‚    kubectl rollout status deployment/hello-world             â”‚
â”‚                                                                â”‚
â”‚    Resultado: 50 pods pending (no hay nodos disponibles)     â”‚
â”‚    UtilizaciÃ³n: ~150% (sobrepasado)                          â”‚
â”‚    Tiempo: 0s (instant creation request)                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3. Karpenter Detection                                         â”‚
â”‚    Controller monitorea: PendingPods                          â”‚
â”‚    - 50 pods sin nodo asignado                               â”‚
â”‚    - UtilizaciÃ³n: exceed 150% â†’ trigger scale-up            â”‚
â”‚    - Reqs: CPU, memoria, labels (soportan t3/m5)            â”‚
â”‚                                                                â”‚
â”‚    NodePool spec:                                             â”‚
â”‚    - Requisitos: t3.medium, m5.large (on-demand)            â”‚
â”‚    - LÃ­mites: 200 CPU, 400Gi RAM                            â”‚
â”‚    - ConsolidaciÃ³n: WhenUnderutilized                       â”‚
â”‚                                                                â”‚
â”‚    EC2NodeClass spec:                                         â”‚
â”‚    - AMI: AL2023 (Amazon Linux 2023)                         â”‚
â”‚    - Subnets: Private subnets (multi-AZ)                     â”‚
â”‚    - SecurityGroup: cluster SG                               â”‚
â”‚    - IAM Role: KarpenterNodeRole (with kubelet)             â”‚
â”‚    - Tags: karpenter.sh/discovery=eks-observability          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4. Karpenter Decision & Action                                â”‚
â”‚    Algoritmo:                                                  â”‚
â”‚    1. Estima CPU/RAM requerida: 50 pods Ã— (100m, 128Mi)     â”‚
â”‚       = 5 CPU, 6.4Gi RAM                                     â”‚
â”‚    2. Verifica lÃ­mites: 5 CPU < 200 CPU âœ…                   â”‚
â”‚    3. Selecciona instancia: t3.medium (1 CPU, 1Gi)          â”‚
â”‚       Necesita ~5 instancias para 50 pods                    â”‚
â”‚    4. Lanza instancias: 5 x t3.medium (on-demand)           â”‚
â”‚                                                                â”‚
â”‚    AWS API Calls (via IAM role):                             â”‚
â”‚    - ec2:RunInstances (5 times, different AZs)              â”‚
â”‚    - Subnet: private-1a (1 instance)                         â”‚
â”‚    - Subnet: private-1b (2 instances)                        â”‚
â”‚    - Subnet: private-1c (2 instances)                        â”‚
â”‚    - Security Group: cluster SG                              â”‚
â”‚    - IAM Role: KarpenterNodeRole                             â”‚
â”‚    - Tags: karpenter.sh/discovery, Name, managed-by          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 5. Instances Launched                                         â”‚
â”‚    Bootstrapping (cloud-init/user-data):                      â”‚
â”‚    1. AMI boots: AL2023                                      â”‚
â”‚    2. Kubelet starts: joins EKS cluster                      â”‚
â”‚    3. CNI plugin: assigns pod IPs from subnets               â”‚
â”‚    4. Node registers: new nodes in kubectl get nodes         â”‚
â”‚    5. Available for scheduling: âœ…                            â”‚
â”‚                                                                â”‚
â”‚    Nodes state:                                               â”‚
â”‚    - NAME: ip-10-0-1-123.ec2.internal (private IP)          â”‚
â”‚    - STATUS: Ready                                            â”‚
â”‚    - ROLES: <none> (data plane only)                         â”‚
â”‚    - AGE: <1m                                                â”‚
â”‚    - VERSION: v1.29.x                                        â”‚
â”‚    - CAPACITY: 1 CPU, 1Gi RAM (t3.medium)                   â”‚
â”‚    - ALLOCATABLE: 0.9 CPU, 0.8Gi RAM (reserved)             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 6. Scheduler Assignments                                      â”‚
â”‚    Kubernetes Scheduler sees:                                 â”‚
â”‚    - 50 pods pending                                         â”‚
â”‚    - 5 new nodes ready                                       â”‚
â”‚    - Distribuye pods across nodos (spread for HA)            â”‚
â”‚                                                                â”‚
â”‚    Resultado:                                                  â”‚
â”‚    - Node 1: 10 pods (hello-world)                           â”‚
â”‚    - Node 2: 10 pods (hello-world)                           â”‚
â”‚    - Node 3: 10 pods (hello-world)                           â”‚
â”‚    - Node 4: 10 pods (hello-world)                           â”‚
â”‚    - Node 5: 10 pods (hello-world)                           â”‚
â”‚    - âœ… Todos los pods running                                â”‚
â”‚    - âœ… Distributed across AZs                               â”‚
â”‚                                                                â”‚
â”‚    Tiempo total: ~2-3 minutos (launch + kubelet + scheduler) â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 7. Estado Durante Peak                                         â”‚
â”‚    Nodos: 2 managed + 5 Karpenter = 7 nodos totales         â”‚
â”‚    Pods: 50 running + otros = ~55 pods                      â”‚
â”‚    UtilizaciÃ³n: ~90% (healthy range)                         â”‚
â”‚    Costo: ~7 instancias Ã— precio-horario                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 8. Evento: Usuario escala abajo                               â”‚
â”‚    kubectl scale deployment hello-world --replicas=1        â”‚
â”‚    kubectl rollout status deployment/hello-world             â”‚
â”‚                                                                â”‚
â”‚    Resultado: 49 pods deleted                                â”‚
â”‚    UtilizaciÃ³n: ~10% (bajo)                                  â”‚
â”‚    Consolidation policy: WhenUnderutilized â†’ trigger         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 9. Karpenter Consolidation                                    â”‚
â”‚    Algoritmo:                                                  â”‚
â”‚    1. Identifica nodos subutilizados (<10% CPU, <10% RAM)   â”‚
â”‚    2. Verifica si pods pueden movarse a otros nodos          â”‚
â”‚    3. Drains node (evict pods gracefully)                    â”‚
â”‚    4. Espera pod rescheduling                                â”‚
â”‚    5. Termina instancia AWS (ec2:TerminateInstances)        â”‚
â”‚    6. Elimina node del cluster                               â”‚
â”‚                                                                â”‚
â”‚    Proceso:                                                    â”‚
â”‚    - Marca 4 nodos como "Draining"                           â”‚
â”‚    - Avisa: 10 min para graceful shutdown (por defecto)      â”‚
â”‚    - Pods en esos nodos â†’ reschedule a remaining nodes       â”‚
â”‚    - Termina 4 x t3.medium instances                         â”‚
â”‚    - Conserva 1 nodo (pod running) + managed 2              â”‚
â”‚                                                                â”‚
â”‚    Tiempo: ~1-5 minutos (drain + termination)                â”‚
â”‚    Ahorro: 4 instancias Ã— precio-horario                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚
                 â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 10. Estado Final (Back to Normal)                              â”‚
â”‚     Nodos: 2 managed + 1 Karpenter = 3 nodos                â”‚
â”‚     Pods: 1 hello-world + observability + controllers = ~5   â”‚
â”‚     UtilizaciÃ³n: ~20%                                         â”‚
â”‚     Costo: 3 instancias Ã— precio-horario (reduced)          â”‚
â”‚                                                                â”‚
â”‚     âœ… Autoscaling completo                                    â”‚
â”‚     âœ… Costos optimizados (escala arriba y abajo)            â”‚
â”‚     âœ… Sin intervenciÃ³n manual                                â”‚
â”‚     âœ… ConsolidaciÃ³n automÃ¡tica                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ“‹ TABLA: CuÃ¡ndo Se Ejecuta Cada Componente

| Fase | Componente | Trigger | AcciÃ³n | Resultado |
|------|-----------|---------|--------|-----------|
| **Init** | Terraform | `terraform init` | Descarga modules y providers | `.terraform/`, `.lock.hcl` |
| **Plan** | Terraform | `terraform plan` | Valida configuraciÃ³n, simula cambios | Plan output (no cambios) |
| **Apply** | Terraform | `terraform apply` | Crea VPC, EKS, IRSA, K8s resources | Cluster operativo |
| **Post-Apply** | Helm (Manual) | `helm install` (CLI) | Instala charts (ALB, ESO, Alloy) | Pods en kube-system, observability |
| **Reconcile** | ALB Controller | Detecta Ingress | Crea ALB en AWS | DNS asignado a Ingress |
| **Continuous** | Alloy DaemonSet | Timer (15s) | Scrapes pods y envÃ­a a AMP | MÃ©tricas en AMP |
| **Continuous** | ESO | Timer (15s) | Sincroniza AWS Secrets â†’ K8s | Secrets actualizados |
| **On-Demand** | Karpenter | Pod pending | Lanza nodos | Pods scheduled |
| **On-Demand** | Karpenter | Node underutilized | Drena y termina nodos | Costs reducidos |

---

